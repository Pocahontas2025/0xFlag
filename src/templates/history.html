{% extends "base.html" %}

{% block title %}0xFlag - Historial{% endblock %}

{% block content %}
<div class="container px-5 my-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bolder text-white mb-0">ðŸ“œ Historial de Comandos</h1>
        
        <form action="/clear_history" method="POST" onsubmit="return confirm('Â¿EstÃ¡s seguro de que quieres borrar TODO el historial? Esta acciÃ³n no se puede deshacer.');">
            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i> Limpiar Historial</button>
        </form>
    </div>

    <div class="card bg-secondary text-white mb-4 border-0">
        <div class="card-body">
            <div class="input-group">
                <span class="input-group-text bg-dark text-white border-dark"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control bg-dark text-white border-dark" placeholder="Filtrar por comando, fecha, IP...">
            </div>
        </div>
    </div>

    <div class="card bg-dark border border-secondary shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" id="logsTable">
                    <thead class="bg-secondary text-uppercase small">
                        <tr>
                            <th scope="col" style="width: 20%;">Fecha / Hora</th>
                            <th scope="col">Comando Generado</th>
                            <th scope="col" style="width: 10%;" class="text-center">AcciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if logs %}
                            {% for log in logs %}
                            <tr>
                                <td class="text-white-50 small align-middle">{{ log.timestamp }}</td>
                                <td class="font-monospace text-success align-middle">{{ log.command }}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-light btn-copiar"
                                            data-copy="{{ log.command | escape }}"
                                            title="Copiar">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No hay comandos registrados todavÃ­a.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <small class="text-muted">Mostrando los Ãºltimos registros locales de <code>logs/history.txt</code></small>
    </div>
</div>

<script>
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('#logsTable tbody tr');

        rows.forEach(row => {
            let text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });

    
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".btn-copiar").forEach(btn => {
            btn.addEventListener("click", () => {
                const textToCopy = btn.dataset.copy;

                // Fallback compatible with HTTP
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand("copy");
                    if (!successful) throw new Error();
                } catch (err) {
                    alert("No se pudo copiar al portapapeles. Copia manualmente.");
                }

                document.body.removeChild(textArea);

                // Visual feedback (per button)
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Copiado';
                btn.classList.add("copiado");

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove("copiado");
                }, 1500);
            });
        });
    });
</script>
{% endblock %}
